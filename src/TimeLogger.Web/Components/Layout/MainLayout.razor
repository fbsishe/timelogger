@inherits LayoutComponentBase
@inject IServiceScopeFactory ScopeFactory
@implements IAsyncDisposable

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@(_ => _drawerOpen = !_drawerOpen)" />
        <MudText Typo="Typo.h6" Class="ml-3">TimeLogger</MudText>
        <MudSpacer />
        @if (_unmappedCount > 0)
        {
            <MudBadge Content="@_unmappedCount" Color="Color.Error" Overlap="true">
                <MudIconButton Icon="@Icons.Material.Filled.Warning" Color="Color.Warning"
                               Href="/entries" />
            </MudBadge>
        }
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <MudNavMenu>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            <MudNavLink Href="/mapping-rules" Icon="@Icons.Material.Filled.Rule">
                Mapping Rules
            </MudNavLink>
            <MudNavLink Href="/entries" Icon="@Icons.Material.Filled.List">
                Entries
                @if (_unmappedCount > 0)
                {
                    <MudBadge Content="@_unmappedCount" Color="Color.Error" Class="ml-2" />
                }
            </MudNavLink>
            <MudNavLink Href="/import-history" Icon="@Icons.Material.Filled.History">
                Import History
            </MudNavLink>
            <MudNavLink Href="/sources" Icon="@Icons.Material.Filled.Source">
                Import Sources
            </MudNavLink>
            <MudNavLink Href="/upload" Icon="@Icons.Material.Filled.UploadFile">
                File Upload
            </MudNavLink>
            <MudNavLink Href="/timelog-sync" Icon="@Icons.Material.Filled.Sync">
                Timelog Sync
            </MudNavLink>
            <MudNavLink Href="/submission" Icon="@Icons.Material.Filled.Send">
                Submission
            </MudNavLink>
            <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">
                Settings
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 px-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private int _unmappedCount;
    private readonly CancellationTokenSource _cts = new();

    protected override async Task OnInitializedAsync()
    {
        await RefreshBadgeAsync();
        _ = RunPeriodicRefreshAsync(_cts.Token);
    }

    private async Task RunPeriodicRefreshAsync(CancellationToken ct)
    {
        using var timer = new PeriodicTimer(TimeSpan.FromSeconds(30));
        while (await timer.WaitForNextTickAsync(ct))
        {
            await RefreshBadgeAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RefreshBadgeAsync()
    {
        await using var scope = ScopeFactory.CreateAsyncScope();
        var svc = scope.ServiceProvider.GetRequiredService<IEntryService>();
        _unmappedCount = await svc.GetUnmappedCountAsync();
    }

    public async ValueTask DisposeAsync()
    {
        await _cts.CancelAsync();
        _cts.Dispose();
    }
}
