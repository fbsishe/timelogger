@page "/submission"
@rendermode InteractiveServer
@inject ISubmissionService SubmissionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Submission – TimeLogger</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Submission Pipeline</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" />
}
else
{
    @* Stats row *@
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Ready to Submit</MudText>
                <MudText Typo="Typo.h4"
                         Color="@(_readyEntries.Count > 0 ? Color.Info : Color.Default)">
                    @_readyEntries.Count
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Mapped entries with a Timelog task assigned
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Submitted</MudText>
                <MudText Typo="Typo.h4" Color="Color.Success">@_submittedCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Total all-time</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Failed</MudText>
                <MudText Typo="Typo.h4"
                         Color="@(_failedCount > 0 ? Color.Error : Color.Default)">
                    @_failedCount
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Submission attempts</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* Action bar *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3" Spacing="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Send"
                   OnClick="SubmitSelectedAsync"
                   Disabled="@(_submitting || !_selectedEntries.Any())">
            @(_submitting ? "Submitting…" : $"Submit Selected ({_selectedEntries.Count})")
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.DoneAll"
                   OnClick="SubmitAllAsync"
                   Disabled="@(_submitting || _readyEntries.Count == 0)">
            @(_submitting ? "Submitting…" : $"Submit All ({_readyEntries.Count})")
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                   StartIcon="@Icons.Material.Filled.Block"
                   OnClick="SkipSelectedAsync"
                   Disabled="@(_submitting || !_selectedEntries.Any())">
            Skip Selected (@_selectedEntries.Count)
        </MudButton>
        <MudButton Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="LoadAsync">
            Refresh
        </MudButton>
        @if (_submitting)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
        }
    </MudStack>

    @* Ready entries table *@
    @if (_readyEntries.Count > 0)
    {
        <MudText Typo="Typo.h6" Class="mb-2">Ready to Submit</MudText>
        <MudTable T="ReadyEntryItem" Items="_readyEntries"
                  MultiSelection="true"
                  @bind-SelectedItems="_selectedEntries"
                  Hover="true" Dense="true" Striped="true" Elevation="1"
                  Class="mb-4">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.WorkDate)">Date</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.SourceName)">Source</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.IssueKey ?? string.Empty)">Issue Key</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.Description ?? string.Empty)">Description</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.Hours)">Hours</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.UserDisplay ?? string.Empty)">Employee</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<ReadyEntryItem, object>(x => x.TimelogTaskName ?? string.Empty)">Timelog Task</MudTableSortLabel></MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.WorkDate.ToString("yyyy-MM-dd")</MudTd>
                <MudTd>@context.SourceName</MudTd>
                <MudTd>@context.IssueKey</MudTd>
                <MudTd Style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    @context.Description
                </MudTd>
                <MudTd>@context.Hours</MudTd>
                <MudTd>@(context.UserDisplay ?? "—")</MudTd>
                <MudTd>@(context.TimelogTaskName ?? "—")</MudTd>
                <MudTd>
                    <MudTooltip Text="Skip — hide this entry without submitting">
                        <MudIconButton Icon="@Icons.Material.Filled.Block"
                                       Size="Size.Small" Color="Color.Warning"
                                       OnClick="@(() => SkipOneAsync(context.Id))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else if (_submittedCount == 0)
    {
        <MudAlert Severity="Severity.Info">
            No entries are ready for submission yet.
            Map some entries first using the <MudLink Href="/mapping-rules">Mapping Rules</MudLink>
            or the <MudLink Href="/">Dashboard</MudLink>.
        </MudAlert>
    }

    @* Audit trail *@
    @if (_history.Count > 0)
    {
        <MudText Typo="Typo.h6" Class="mb-2">Recent Submission History</MudText>
        <MudTable Items="_history" Hover="true" Dense="true" Striped="true" Elevation="1"
                  RowsPerPage="50">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.WorkDate)">Date</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.UserDisplay ?? string.Empty)">Person</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.SourceName)">Source</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.IssueKey ?? string.Empty)">Issue Key</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.Description ?? string.Empty)">Description</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.Hours)">Hours</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.SubmittedAt)">Submitted At</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<SubmissionHistoryItem, object>(x => x.AttemptCount)">Attempts</MudTableSortLabel></MudTh>
                <MudTh>Error</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.WorkDate.ToString("yyyy-MM-dd")</MudTd>
                <MudTd>@(context.UserDisplay ?? "—")</MudTd>
                <MudTd>@context.SourceName</MudTd>
                <MudTd>@context.IssueKey</MudTd>
                <MudTd Style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    @context.Description
                </MudTd>
                <MudTd>@context.Hours</MudTd>
                <MudTd>@context.SubmittedAt.ToLocalTime().ToString("g")</MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small"
                             Color="@(context.Status == TimeLogger.Domain.SubmissionStatus.Success
                                 ? Color.Success : Color.Error)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd>@context.AttemptCount</MudTd>
                <MudTd Style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                    @context.ErrorMessage
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
}

@code {
    private bool _loading = true;
    private bool _submitting;
    private List<ReadyEntryItem> _readyEntries = [];
    private HashSet<ReadyEntryItem> _selectedEntries = [];
    private int _submittedCount;
    private int _failedCount;
    private List<SubmissionHistoryItem> _history = [];

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;
        _selectedEntries = [];
        _readyEntries   = (await SubmissionService.GetReadyToSubmitAsync()).ToList();
        _submittedCount = await SubmissionService.GetSubmittedCountAsync();
        _failedCount    = await SubmissionService.GetFailedCountAsync();
        _history        = (await SubmissionService.GetRecentAsync()).ToList();
        _loading = false;
    }

    private async Task SubmitSelectedAsync()
    {
        if (!_selectedEntries.Any()) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Submit Selected",
            $"Submit {_selectedEntries.Count} selected entr{(_selectedEntries.Count == 1 ? "y" : "ies")} to Timelog?",
            yesText: "Submit", cancelText: "Cancel");
        if (confirmed != true) return;

        _submitting = true;
        var ids = _selectedEntries.Select(e => e.Id).ToList();
        await SubmissionService.SubmitSelectedAsync(ids);
        Snackbar.Add($"Submitted {ids.Count} entr{(ids.Count == 1 ? "y" : "ies")}.", Severity.Success);
        _submitting = false;
        await LoadAsync();
    }

    private async Task SkipOneAsync(int entryId)
    {
        await SubmissionService.SkipAsync(entryId);
        await LoadAsync();
    }

    private async Task SkipSelectedAsync()
    {
        if (!_selectedEntries.Any()) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Skip Selected",
            $"Hide {_selectedEntries.Count} selected entr{(_selectedEntries.Count == 1 ? "y" : "ies")} from submission? They will be marked Ignored.",
            yesText: "Skip", cancelText: "Cancel");
        if (confirmed != true) return;

        foreach (var entry in _selectedEntries.ToList())
            await SubmissionService.SkipAsync(entry.Id);

        Snackbar.Add($"Skipped {_selectedEntries.Count} entr{(_selectedEntries.Count == 1 ? "y" : "ies")}.", Severity.Info);
        await LoadAsync();
    }

    private async Task SubmitAllAsync()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Submit All",
            $"Submit all {_readyEntries.Count} ready entries to Timelog?",
            yesText: "Submit All", cancelText: "Cancel");
        if (confirmed != true) return;

        _submitting = true;
        await SubmissionService.TriggerSubmitAllAsync();
        Snackbar.Add("Submission job enqueued. Refresh in a moment.", Severity.Success);
        _submitting = false;
    }
}
